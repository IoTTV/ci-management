- project:
    name: iotivity-jobs
    jobs:
        - 'iotivity-merge'
        - 'iotivity-verify-{component}'
        - 'iotivity-verify-osx'
        - 'iotivity-verify-windows-{vs-version}'
        - 'iotivity-sonar-runner'
    component:
        - 'linux_unsecured'
        - 'linux_unsecured_with_ra'
        - 'linux_unsecured_with_rd'
        - 'linux_unsecured_with_java'
        - 'linux_secured'
        - 'linux_secured_with_ra'
        - 'linux_secured_with_rd'
        - 'linux_secured_with_java'
        - 'android_armeabi'
        - 'android_x86'
        - 'arduino'
        - 'tizen'
        - 'simulator'
        - 'unit_tests'
    vs-version:
        - 'vs2013'
        - 'vs2015'
    project: 'iotivity'

- job-template:
    name: 'iotivity-verify-{component}'

    project-type: freestyle
    node: 'ubuntu1204'
    concurrent: true
    disabled: true

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit-trigger-patch-submitted:
            project: '{project}'
            branch: '**'

    wrappers:
        - timestamps

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            ./auto_build.sh {component}

    publishers:
        - archive-artifacts
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-verify-windows-{vs-version}'

    project-type: freestyle
    node: '{vs-version}'
    concurrent: true
    disabled: true

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit:
            server-name: 'iotivity'
            trigger-on:
                - patchset-created-event:
                    exclude-drafts: 'false'
                    exclude-trivial-rebase: 'false'
                    exclude-no-code-change: 'true'
                - draft-published-event
                - comment-added-contains-event:
                    comment-contains-value: 'verify all'
                - comment-added-contains-event:
                    comment-contains-value: 'reverify'
            projects:
                - project-compare-type: 'ANT'
                  project-pattern: '{project}'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '^(?!.*1.1-rel).*$'

    wrappers:
        - timestamps

    builders:
        - batch:
            !include-raw-escape: include-raw-iotivity-windows-bootstrap.bat
        - batch: |
            @echo off
            run.bat build
            run.bat test
            run.bat clean

    publishers:
        - archive-artifacts
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-verify-osx'

    project-type: freestyle
    node: 'osx1010'
    concurrent: true
    disabled: true

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit-trigger-patch-submitted:
            project: '{project}'
            branch: '**'

    wrappers:
        - timestamps

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-osx-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            PATH=$PATH:/usr/local/bin/
            if (git rev-list HEAD | grep -q d0b861c0276208b3fd1b29bf98908e401c7ca17f); then
              ./auto_build.sh darwin
            fi
            # Run Tests against OSX 10.10 without Logging
            echo "*********** Build for OSX 10.10 *************"
            scons TARGET_OS=darwin SYS_VERSION=10.10 RELEASE=false
            scons TARGET_OS=darwin SYS_VERSION=10.10 RELEASE=false -c
            scons TARGET_OS=darwin SYS_VERSION=10.10 RELEASE=false LOGGING=false
            export DYLD_LIBRARY_PATH=./extlibs/gtest/gtest-1.7.0/lib/.libs
            ./out/darwin/x86_64/debug/resource/csdk/stack/test/stacktests

    publishers:
        - valgrind-report
        - xunit-report
        - archive-artifacts
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-merge'

    project-type: freestyle
    node: 'integration'
    concurrent: true
    disabled: true

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch:
            branch: 'master'
        - gerrit-refspec:
            refspec: ''

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'
            refspec: 'refs/heads/master'

    triggers:
        - gerrit-trigger-patch-merged:
            project: '{project}'
            branch: 'master'

    wrappers:
        - timestamps
        - ssh-agent-credentials:
            users:
                - '{ssh-credentials}'

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            ./auto_build.sh all

    publishers:
        - email-notification:
            mailto: 'oicbuild@intel.com, joseph.l.morrow@intel.com, tbramwell@linuxfoundation.org'

- job-template:
    name: 'iotivity-sonar-runner'

    project-type: freestyle
    node: 'sonar'
    concurrent: true
    disabled: true

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch:
            branch: 'master'
        - gerrit-refspec:
            refspec: ''

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'
            refspec: 'refs/heads/master'

    triggers:
        - gerrit-trigger-silent-patch-merged:
            project: '{project}'
            branch: 'master'

    wrappers:
        - timestamps
        - ssh-agent-credentials:
            users:
                - '{ssh-credentials}'

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-sonar.sh
        - sonar:
            sonar-name: Sonar
            properties: |
                sonar.projectKey=iotivity:master
                sonar.projectName=Iotivity
                sonar.projectVersion=1.1.0

                sonar.sources=resource,service,examples,android,build_common,tools
                sonar.language=c++

                sonar.cxx.compiler.parser=GCC
                sonar.cxx.errorRecoveryEnabled=True

                sonar.cxx.includeDirectories=resource,service,examples,android,build_common,tools

                sonar.cxx.valgrind.reportPath=*.memcheck
                sonar.cxx.vera.reportPath=vera-report.xml
                sonar.cxx.cppcheck.reportPath=cppcheck-report.xml
                sonar.cxx.rats.reportPath=rats-report.xml

    publishers:
        - archive-artifacts:
            artifacts: '*-report.xml'
